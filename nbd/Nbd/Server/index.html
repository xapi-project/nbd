<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Server (nbd.Nbd.Server)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">nbd</a> &#x00BB; <a href="../index.html">Nbd</a> &#x00BB; Server</nav><header class="odoc-preamble"><h1>Module <code><span>Nbd.Server</span></code></h1><p>A Server which allows you to expose an existing block device to remote clients over NBD.</p></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../S/module-type-SERVER/index.html">S.SERVER</a></span></code></summary><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>An open connection to an NBD client</p></div></div><div class="odoc-spec"><div class="spec type" id="type-size" class="anchored"><a href="#type-size" class="anchor"></a><code><span><span class="keyword">type</span> size</span><span> = int64</span></code></div><div class="spec-doc"><p>The size of a remote disk</p></div></div><div class="odoc-spec"><div class="spec type" id="type-name" class="anchored"><a href="#type-name" class="anchor"></a><code><span><span class="keyword">type</span> name</span><span> = string</span></code></div><div class="spec-doc"><p>The name of an export. In the 'new style' protocol as used in nbd &gt;= 2.9.17 the client must select an export by name.</p></div></div><div class="odoc-spec"><div class="spec exception" id="exception-Client_requested_abort" class="anchored"><a href="#exception-Client_requested_abort" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Client_requested_abort</span></span></code></div><div class="spec-doc"><p>The client terminated the option haggling phase by sending NBD_OPT_ABORT</p></div></div><div class="odoc-spec"><div class="spec value" id="val-connect" class="anchored"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : 
  <span><a href="../Channel/index.html#type-cleartext_channel">Channel.cleartext_channel</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?offer:<span><a href="#type-name">name</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-name">name</a> * <a href="#type-t">t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>connect cleartext_channel ?offer ()</code> performs the 'new style' initial handshake and options negotiation. Note that FORCEDTLS mode will be used in the negotiation unless <code>cleartext_channel.make_tls_channel</code> is None, signifying NOTLS mode. If <code>?offer</code> is provided then these names will be returned if the client requests a list of exports, otherwise we will return EPERM. The client's choice of name is returned which must be looked up by the application. If the name is invalid, the only option is to close the connection. If the name is valid then use the <code>serve</code> function.</p><p>Raises <a href="#exception-Client_requested_abort"><code>Client_requested_abort</code></a> if the client aborts the option haggilng phase instead of entering the transmission phase</p></div></div><div class="odoc-spec"><div class="spec value" id="val-serve" class="anchored"><a href="#val-serve" class="anchor"></a><code><span><span class="keyword">val</span> serve : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?read_only:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <span class="xref-unresolved">Mirage_block</span>.S <span class="keyword">with</span> <span class="keyword">type</span> <span class="xref-unresolved">t</span> = <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>serve t read_only block b</code> runs forever processing requests from <code>t</code>, using <code>block</code> device type <code>b</code>. If <code>read_only</code> is true, which is the default, the <code>block</code> device <code>b</code> is served in read-only mode: the server will set the NBD_FLAG_READ_ONLY transmission flag, and if the client issues a write command, the server will send an EPERM error to the client and will terminate the session.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close t</code> shuts down the connection <code>t</code> and frees any allocated resources</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_connection" class="anchored"><a href="#val-with_connection" class="anchor"></a><code><span><span class="keyword">val</span> with_connection : 
  <span><a href="../Channel/index.html#type-cleartext_channel">Channel.cleartext_channel</a> <span class="arrow">&#45;&gt;</span></span>
  <span>?offer:<span><a href="#type-name">name</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_connection clearchan ~offer f</code> calls <code>connect clearchan ~offer</code> and attempts to apply <code>f</code> to the resulting <code>t</code>, with a guarantee to call <code>close t</code> afterwards.</p></div></div></details></div></div></body></html>