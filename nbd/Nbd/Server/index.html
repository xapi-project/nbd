<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Server (nbd.Nbd.Server)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../index.html">nbd</a> &#x00BB; <a href="../index.html">Nbd</a> &#x00BB; Server</nav><h1>Module <code>Nbd.Server</code></h1></header><aside><p>A Server which allows you to expose an existing block device to remote clients over NBD.</p></aside><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../S/index.html#module-type-SERVER">S.SERVER</a></code></span></summary><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>An open connection to an NBD client</p></dd></dl><dl><dt class="spec type" id="type-size"><a href="#type-size" class="anchor"></a><code><span class="keyword">type</span> size</code><code> = int64</code></dt><dd><p>The size of a remote disk</p></dd></dl><dl><dt class="spec type" id="type-name"><a href="#type-name" class="anchor"></a><code><span class="keyword">type</span> name</code><code> = string</code></dt><dd><p>The name of an export. In the 'new style' protocol as used in nbd &gt;= 2.9.17 the client must select an export by name.</p></dd></dl><dl><dt class="spec exception" id="exception-Client_requested_abort"><a href="#exception-Client_requested_abort" class="anchor"></a><code><span class="keyword">exception</span> </code><code><span class="exception">Client_requested_abort</span></code></dt><dd><p>The client terminated the option haggling phase by sending NBD_OPT_ABORT</p></dd></dl><dl><dt class="spec value" id="val-connect"><a href="#val-connect" class="anchor"></a><code><span class="keyword">val</span> connect : <a href="../Channel/index.html#type-cleartext_channel">Channel.cleartext_channel</a> <span>&#45;&gt;</span> <span>?&#8288;offer:<span><a href="index.html#type-name">name</a> list</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-name">name</a> * <a href="index.html#type-t">t</a>)</span> Lwt.t</span></code></dt><dd><p><code>connect cleartext_channel ?offer ()</code> performs the 'new style' initial handshake and options negotiation. Note that FORCEDTLS mode will be used in the negotiation unless <code>cleartext_channel.make_tls_channel</code> is None, signifying NOTLS mode. If <code>?offer</code> is provided then these names will be returned if the client requests a list of exports, otherwise we will return EPERM. The client's choice of name is returned which must be looked up by the application. If the name is invalid, the only option is to close the connection. If the name is valid then use the <code>serve</code> function.</p><p>Raises <a href="index.html#exception-Client_requested_abort"><code>Client_requested_abort</code></a> if the client aborts the option haggilng phase instead of entering the transmission phase</p></dd></dl><dl><dt class="spec value" id="val-serve"><a href="#val-serve" class="anchor"></a><code><span class="keyword">val</span> serve : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>?&#8288;read_only:bool</span> <span>&#45;&gt;</span> <span>(<span class="keyword">module</span> Mirage_block.S <span class="keyword">with</span> <span class="keyword">type</span> t = <span class="type-var">'b</span>)</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>serve t read_only block b</code> runs forever processing requests from <code>t</code>, using <code>block</code> device type <code>b</code>. If <code>read_only</code> is true, which is the default, the <code>block</code> device <code>b</code> is served in read-only mode: the server will set the NBD_FLAG_READ_ONLY transmission flag, and if the client issues a write command, the server will send an EPERM error to the client and will terminate the session.</p></dd></dl><dl><dt class="spec value" id="val-close"><a href="#val-close" class="anchor"></a><code><span class="keyword">val</span> close : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>close t</code> shuts down the connection <code>t</code> and frees any allocated resources</p></dd></dl><dl><dt class="spec value" id="val-with_connection"><a href="#val-with_connection" class="anchor"></a><code><span class="keyword">val</span> with_connection : <a href="../Channel/index.html#type-cleartext_channel">Channel.cleartext_channel</a> <span>&#45;&gt;</span> <span>?&#8288;offer:<span><a href="index.html#type-name">name</a> list</span></span> <span>&#45;&gt;</span> <span>(string <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>with_connection clearchan ~offer f</code> calls <code>connect clearchan ~offer</code> and attempts to apply <code>f</code> to the resulting <code>t</code>, with a guarantee to call <code>close t</code> afterwards.</p></dd></dl></details></div></div></div></div></body></html>